# 实验 2：企业图谱 + 业务文档的混合 RAG 检索

## 0. 问题背景与初衷

### 0.1 原始问题描述

**问题 2：RAG 与知识库方案 - 针对异构数据源的知识整合**

在虚拟销售 AI 场景中，销售人员需要同时掌握两类信息：

#### 左手：企业图谱数据（结构化）
- **数据来源**：类似天眼查、企查查的企业信息
- **数据结构**：实体-关系图谱
- **典型内容**：
  - 企业基本信息：注册资本、成立时间、行业分类、经营范围
  - 组织关系：股权结构、母子公司、法人/高管
  - 业务信息：资质证书、历史合作、行业地位
  - 关联关系：供应商、客户、竞争对手

**示例场景**：
```
销售：这家公司是谁？
系统：XX科技，成立于2015年，注册资本5000万，主营AI芯片研发
      母公司是YY集团（上市公司），CEO是张三（曾任华为高管）
      2023年获得B轮融资2亿，投资方包括红杉资本
```

#### 右手：业务文档（非结构化）
- **数据来源**：乙方（如 TechFlow）的业务材料
- **文档形式**：Word、PPT、PDF
- **内容类型**：文本、图片、图表
- **典型内容**：
  - 产品手册
  - 解决方案白皮书
  - 客户案例（成功案例、失败教训）
  - 技术文档、FAQ

**特点**：文档之间耦合性不强，每个文档相对独立

#### 核心挑战

1. **异构数据融合**：
   - 企业图谱是**结构化图数据**（实体 + 关系）
   - 业务文档是**非结构化文本**
   - 如何让 RAG 系统同时查询两者？

2. **检索策略**：
   - 企业名称、产品型号需要**精确匹配**（BM25 稀疏检索）
   - 需求描述需要**语义理解**（Dense 向量检索）
   - 如何设计混合检索策略？

3. **知识库设计**：
   - 如何组织企业图谱数据？
   - 如何与文档向量索引协同工作？
   - 如何形成"有效的炼丹炉"？

4. **实际应用场景**：
```
客户："我想了解XX公司的背景，他们之前有没有用过类似方案？
       适合推荐哪个产品？"

系统需要：
1. 查企业图谱 → 了解公司规模、行业、历史
2. 查合作记录 → 是否有类似项目经验
3. 查业务文档 → 匹配合适的产品和案例
4. 融合信息 → 给出综合推荐
```

### 0.2 实验目标

本实验要验证的核心问题：

1. ✅ **混合检索是否必要？**
   - 纯 Dense 向量 vs BM25 + Dense 混合
   - 在企业名称、产品型号等关键词匹配上的差异

2. ✅ **企业图谱如何有效融合？**
   - 图谱数据如何转化为 RAG 可用的格式
   - 关系查询（如"母公司是谁"）如何实现

3. ✅ **多源融合的价值？**
   - 单用企业图谱 vs 单用文档 vs 两者融合
   - 融合后回答的全面性和准确性提升

4. ✅ **实际工程可行性？**
   - 性能开销（混合检索、图谱查询）
   - 复杂度 vs 收益的权衡

---

## 1. 技术方案设计

### 1.1 混合检索架构（Hybrid Retrieval）

#### 为什么需要混合检索？

**场景 1：关键词精确匹配**
```
查询："DataStream Pro 的价格是多少？"

纯 Dense 向量：可能召回 "DataStream Lite" 或 "数据流处理平台" 的文档
BM25 稀疏检索：精确匹配 "DataStream Pro"，确保召回正确产品
```

**场景 2：企业名称匹配**
```
查询："XX科技之前有没有合作过？"

纯 Dense 向量：可能召回相似行业的公司
BM25：精确匹配 "XX科技"，定位到正确企业
```

**场景 3：语义理解**
```
查询："我们想降低成本，有什么方案？"

BM25：只能匹配 "成本" 关键词
Dense 向量：理解 "降低成本" ≈ "节省预算" ≈ "性价比高"
```

#### 混合检索流程

```python
# 第 1 步：BM25 稀疏检索（关键词精确匹配）
bm25_results = bm25_search(query, corpus, top_k=20)
# 优势：企业名、产品型号、技术名称等精确匹配

# 第 2 步：Dense 向量检索（语义匹配）
query_vector = embed(query)
dense_results = vector_search(query_vector, index, top_k=20)
# 优势：理解同义词、上下文、隐含需求

# 第 3 步：RRF 融合（Reciprocal Rank Fusion）
fused_results = rrf_fusion(bm25_results, dense_results, k=60)
# 公式：score(doc) = sum(1 / (k + rank_i)) for all rankings

# 第 4 步：Reranking 精排
final_results = reranking_service.rerank(query, fused_results, top_k=5)
# 使用 BAAI/bge-reranker-v2-m3 精确排序
```

**RRF 融合算法**：
```python
def rrf_fusion(rankings: List[List[str]], k: int = 60) -> List[Tuple[str, float]]:
    """
    Reciprocal Rank Fusion

    参数：
        rankings: 多个排序结果 [[doc1, doc2, ...], [doc3, doc1, ...]]
        k: 平滑参数，避免头部文档权重过大

    返回：
        融合后的排序结果 [(doc_id, score), ...]
    """
    scores = {}
    for ranking in rankings:
        for rank, doc_id in enumerate(ranking, start=1):
            if doc_id not in scores:
                scores[doc_id] = 0
            scores[doc_id] += 1 / (k + rank)

    return sorted(scores.items(), key=lambda x: x[1], reverse=True)
```

### 1.2 企业图谱融合方案

#### 方案 A：图谱数据向量化（推荐）✅

将企业图谱的**实体和关系**转化为文本描述，然后向量化索引：

```python
# 1. 企业实体转为文档
entity_doc = f"""
【企业】{company.name}
注册资本：{company.capital}
成立时间：{company.founded_date}
行业分类：{company.industry}
经营范围：{company.business_scope}
CEO：{company.ceo}
"""

# 2. 关系转为文档
relation_doc = f"""
【企业关系】{company.name}
母公司：{company.parent_company}
子公司：{', '.join(company.subsidiaries)}
投资方：{', '.join(company.investors)}
历史合作：{', '.join(company.past_projects)}
"""

# 3. 统一索引
all_docs = entity_docs + relation_docs + business_docs
vector_index.add_documents(all_docs)
```

**优势**：
- ✅ 统一检索流程，无需单独查询图数据库
- ✅ 支持混合检索（BM25 + Dense）
- ✅ 实现简单，适合原型验证

**劣势**：
- ⚠️ 复杂关系查询能力弱（如"3层股权关系"）
- ⚠️ 不适合超大规模图谱（>10万实体）

#### 方案 B：图数据库 + 文档索引并行（未来优化）

```python
# 1. 识别查询意图
if is_graph_query(query):
    # 查询 Neo4j 图数据库
    graph_results = neo4j_query(query)
else:
    # 查询文档索引
    doc_results = hybrid_search(query)

# 2. 融合结果
final_context = merge(graph_results, doc_results)
```

**本实验采用方案 A**（向量化），方案 B 留作后续优化方向

### 1.3 完整架构图

```
用户查询："XX科技适合推荐哪个产品？"
    ↓
【步骤 1】混合检索
    ├─ BM25 稀疏检索 → Top 20（精确匹配 "XX科技"）
    ├─ Dense 向量检索 → Top 20（语义理解 "推荐产品"）
    └─ RRF 融合 → Top 40
    ↓
【步骤 2】多源召回
    ├─ 企业图谱文档（XX科技的基本信息、关系）
    ├─ 业务文档（产品手册、案例）
    └─ 历史合作记录
    ↓
【步骤 3】Reranking 精排
    └─ BAAI/bge-reranker-v2-m3 → Top 5
    ↓
【步骤 4】上下文组织
    ├─ 企业背景（来自图谱）
    ├─ 相关产品（来自业务文档）
    └─ 相似案例（来自案例库）
    ↓
【步骤 5】LLM 生成回答
    └─ 基于 qwen3-8b + RAG（复用实验一结论）
```

## 2. 数据设计

### 2.0 数据总体原则（延续实验一主题）

- **行业背景沿用实验一**：继续围绕虚构厂商 TechFlow 与其虚拟客户生态，保证故事线一致、便于横向对比。
- **数据形态覆盖三类源**：结构化（企业图谱）、非结构化（业务文档）、知识图谱（显式关系边），与最初“左手 + 右手 + 图谱”设想一致。
- **完全虚构且可控**：所有实体、项目、关系均为虚构，避免命中真实训练语料；必要时通过脚本统一生成并打水印字段，如 `source: "synthetic_v2"`。
- **延迟可观测**：在生成数据时即记录 size、token 数等统计，方便后续估算检索与生成耗时。

### 2.1 虚构企业图谱（新增）

设计 **10 家虚构公司**，覆盖不同行业和规模：

```python
COMPANY_GRAPH = [
    {
        "id": "company_001",
        "name": "鼎盛科技有限公司",
        "industry": "智能制造",
        "founded_date": "2015-03-15",
        "capital": "5000万元",
        "business_scope": "工业自动化、数据采集、IoT平台",
        "employees": 500,
        "ceo": "李明",
        "parent_company": "鼎盛集团",
        "subsidiaries": ["鼎盛智能", "鼎盛数据"],
        "investors": ["红杉资本", "IDG"],
        "past_projects": [
            {
                "year": 2023,
                "project": "工厂数字化改造",
                "partner": "TechFlow",
                "product": "DataStream Lite",
                "result": "生产效率提升 35%"
            }
        ],
        "pain_points": ["生产数据孤岛", "设备故障率高", "库存管理混乱"]
    },
    {
        "id": "company_002",
        "name": "星辰金融集团",
        "industry": "金融科技",
        "founded_date": "2010-06-01",
        "capital": "2亿元",
        "business_scope": "证券交易、风控系统、支付平台",
        "employees": 2000,
        "ceo": "王芳",
        "parent_company": None,  # 独立集团
        "subsidiaries": ["星辰证券", "星辰支付", "星辰保险"],
        "investors": ["腾讯", "软银"],
        "past_projects": [],  # 未合作过
        "pain_points": ["实时风控延迟高", "交易数据处理瓶颈", "合规压力大"]
    },
    {
        "id": "company_003",
        "name": "明远物流科技",
        "industry": "智慧物流",
        "founded_date": "2018-09-20",
        "capital": "8000万元",
        "business_scope": "仓储管理、智能调度、物流追踪",
        "employees": 800,
        "ceo": "赵强",
        "parent_company": "明远集团",
        "subsidiaries": ["明远仓储", "明远配送"],
        "investors": ["京东", "菜鸟网络"],
        "past_projects": [
            {
                "year": 2022,
                "project": "智慧仓储系统",
                "partner": "TechFlow",
                "product": "FlowControl-X100",
                "result": "仓储效率提升 28%，拣货错误率降低 45%"
            }
        ],
        "pain_points": ["仓储空间利用率低", "人工拣货错误率高", "运输路线优化困难"]
    },
    {
        "id": "company_004",
        "name": "云帆新能源",
        "industry": "新能源电池",
        "founded_date": "2016-11-08",
        "capital": "3亿元",
        "business_scope": "锂电池研发、动力电池生产、储能系统",
        "employees": 1200,
        "ceo": "孙梅",
        "parent_company": None,
        "subsidiaries": ["云帆电池", "云帆储能"],
        "investors": ["宁德时代", "蔚来资本"],
        "past_projects": [],  # 未合作过(潜在客户)
        "pain_points": ["电池一致性差", "生产线过热停机频繁", "质量追溯困难"]
    },
    {
        "id": "company_005",
        "name": "光明医疗器械",
        "industry": "医疗设备",
        "founded_date": "2012-04-15",
        "capital": "1.5亿元",
        "business_scope": "医疗器械制造、质量认证、设备维护",
        "employees": 600,
        "ceo": "钱伟",
        "parent_company": "光明健康集团",
        "subsidiaries": ["光明影像", "光明检验"],
        "investors": ["红杉资本", "高瓴资本"],
        "past_projects": [
            {
                "year": 2024,
                "project": "GMP质量追溯系统",
                "partner": "TechFlow",
                "product": "FlowMind 平台",
                "result": "FDA审计一次通过，追溯效率提升 90%"
            }
        ],
        "pain_points": ["GMP合规压力大", "批次追溯复杂", "设备校准管理困难"]
    },
    {
        "id": "company_006",
        "name": "恒通电子商务",
        "industry": "电商平台",
        "founded_date": "2014-07-01",
        "capital": "5亿元",
        "business_scope": "B2C电商、供应链管理、数据分析",
        "employees": 3000,
        "ceo": "周丽",
        "parent_company": None,
        "subsidiaries": ["恒通商城", "恒通支付", "恒通云仓"],
        "investors": ["阿里巴巴", "IDG"],
        "past_projects": [],  # 使用竞品
        "pain_points": ["库存周转慢", "供应链可视化差", "大促期间系统压力大"],
        "competitor_product": "XX竞品实时数据平台"  # 标记竞品客户
    },
    {
        "id": "company_007",
        "name": "天启化工集团",
        "industry": "精细化工",
        "founded_date": "2008-03-22",
        "capital": "10亿元",
        "business_scope": "化工原料生产、工艺研发、环保治理",
        "employees": 2500,
        "ceo": "吴刚",
        "parent_company": None,
        "subsidiaries": ["天启材料", "天启环保", "天启研究院"],
        "investors": ["中石化", "中化集团"],
        "past_projects": [
            {
                "year": 2023,
                "project": "化工生产安全监控",
                "partner": "TechFlow",
                "product": "FlowControl-X500",
                "result": "安全事故零发生，能耗降低 22%"
            }
        ],
        "pain_points": ["工艺参数控制精度低", "安全风险高", "能耗成本居高不下"]
    },
    {
        "id": "company_008",
        "name": "晨曦食品加工",
        "industry": "食品制造",
        "founded_date": "2010-05-18",
        "capital": "6000万元",
        "business_scope": "食品加工、冷链物流、品质检测",
        "employees": 400,
        "ceo": "郑敏",
        "parent_company": "晨曦集团",
        "subsidiaries": ["晨曦食品", "晨曦冷链"],
        "investors": ["中粮集团"],
        "past_projects": [
            {
                "year": 2021,
                "project": "食品安全追溯系统",
                "partner": "TechFlow",
                "product": "FlowControl-X100",
                "result": "追溯覆盖率100%，召回响应时间从3天缩短至2小时"
            }
        ],
        "pain_points": ["食品安全追溯要求严格", "冷链温度监控不稳定", "生产批次管理混乱"]
    },
    {
        "id": "company_009",
        "name": "智信半导体",
        "industry": "半导体制造",
        "founded_date": "2019-01-10",
        "capital": "20亿元",
        "business_scope": "芯片设计、晶圆制造、封装测试",
        "employees": 5000,
        "ceo": "冯涛",
        "parent_company": None,
        "subsidiaries": ["智信设计", "智信制造", "智信封测"],
        "investors": ["国家集成电路产业基金", "华为", "小米"],
        "past_projects": [],  # 潜在大客户
        "pain_points": ["良率波动大", "设备维护成本高", "生产数据孤岛严重"]
    },
    {
        "id": "company_010",
        "name": "泰和纺织集团",
        "industry": "纺织服装",
        "founded_date": "2005-08-30",
        "capital": "4亿元",
        "business_scope": "面料生产、成衣制造、供应链管理",
        "employees": 1500,
        "ceo": "胡建国",
        "parent_company": None,
        "subsidiaries": ["泰和面料", "泰和服装", "泰和贸易"],
        "investors": ["申洲国际"],
        "past_projects": [
            {
                "year": 2022,
                "project": "智能染色工艺优化",
                "partner": "TechFlow",
                "product": "FlowMind 平台",
                "result": "染色一次合格率从75%提升至92%，节水25%"
            }
        ],
        "pain_points": ["染色工艺一致性差", "能耗水耗高", "订单交期压力大"]
    }
]
```

**设计原则**：
- ✅ 行业多样化（制造、金融、电商、物流、能源、医疗等）
- ✅ 规模差异（初创 400人、中型 1200人、大型 5000人）
- ✅ 合作历史差异（有合作 6家、无合作 2家、竞品客户 2家）
- ✅ 痛点明确（可匹配 TechFlow 产品）
- ✅ **与实验一对齐**：
  - 复用已有案例客户名称（避免冲突）
  - 使用 TechFlow 已有产品（FlowControl-X100/X500、FlowMind、DataStream）
  - 痛点与产品特性对应（实时性→DataStream Pro、追溯→FlowMind）
- ✅ **完全虚构**：
  - 公司名称造词（鼎盛、星辰、明远等，避免真实公司）
  - CEO 名称常见化（李明、王芳，避免特征名）
  - 数据指标合理但虚构（35% 提升、45% 降低）

### 2.2 企业关系设计

```python
COMPANY_RELATIONS = [
    # ========== 股权关系 ==========
    {"source": "鼎盛集团", "relation": "持股", "target": "鼎盛科技有限公司", "percentage": 80},
    {"source": "鼎盛科技有限公司", "relation": "全资子公司", "target": "鼎盛智能", "percentage": 100},
    {"source": "鼎盛科技有限公司", "relation": "全资子公司", "target": "鼎盛数据", "percentage": 100},

    {"source": "明远集团", "relation": "持股", "target": "明远物流科技", "percentage": 60},
    {"source": "明远物流科技", "relation": "控股子公司", "target": "明远仓储", "percentage": 75},
    {"source": "明远物流科技", "relation": "控股子公司", "target": "明远配送", "percentage": 70},

    {"source": "光明健康集团", "relation": "持股", "target": "光明医疗器械", "percentage": 90},
    {"source": "光明医疗器械", "relation": "全资子公司", "target": "光明影像", "percentage": 100},
    {"source": "光明医疗器械", "relation": "全资子公司", "target": "光明检验", "percentage": 100},

    {"source": "晨曦集团", "relation": "持股", "target": "晨曦食品加工", "percentage": 85},
    {"source": "晨曦食品加工", "relation": "全资子公司", "target": "晨曦食品", "percentage": 100},
    {"source": "晨曦食品加工", "relation": "全资子公司", "target": "晨曦冷链", "percentage": 100},

    # ========== 投资关系 ==========
    {"source": "红杉资本", "relation": "投资", "target": "鼎盛科技有限公司", "round": "B轮", "amount": "2亿元", "year": 2018},
    {"source": "IDG", "relation": "投资", "target": "鼎盛科技有限公司", "round": "A轮", "amount": "5000万元", "year": 2016},
    {"source": "红杉资本", "relation": "投资", "target": "光明医疗器械", "round": "C轮", "amount": "3亿元", "year": 2019},
    {"source": "高瓴资本", "relation": "投资", "target": "光明医疗器械", "round": "C轮", "amount": "2亿元", "year": 2019},

    {"source": "腾讯", "relation": "投资", "target": "星辰金融集团", "round": "战略投资", "amount": "10亿元", "year": 2015},
    {"source": "软银", "relation": "投资", "target": "星辰金融集团", "round": "B轮", "amount": "5亿元", "year": 2012},

    {"source": "京东", "relation": "投资", "target": "明远物流科技", "round": "B轮", "amount": "1.5亿元", "year": 2020},
    {"source": "菜鸟网络", "relation": "投资", "target": "明远物流科技", "round": "B轮", "amount": "1亿元", "year": 2020},

    {"source": "宁德时代", "relation": "投资", "target": "云帆新能源", "round": "A轮", "amount": "2亿元", "year": 2018},
    {"source": "蔚来资本", "relation": "投资", "target": "云帆新能源", "round": "A轮", "amount": "1亿元", "year": 2018},

    {"source": "阿里巴巴", "relation": "投资", "target": "恒通电子商务", "round": "C轮", "amount": "8亿元", "year": 2017},
    {"source": "IDG", "relation": "投资", "target": "恒通电子商务", "round": "B轮", "amount": "3亿元", "year": 2016},

    {"source": "中石化", "relation": "战略投资", "target": "天启化工集团", "round": "战略投资", "amount": "15亿元", "year": 2010},
    {"source": "中化集团", "relation": "战略投资", "target": "天启化工集团", "round": "战略投资", "amount": "10亿元", "year": 2010},

    {"source": "中粮集团", "relation": "战略投资", "target": "晨曦食品加工", "round": "战略投资", "amount": "1亿元", "year": 2015},

    {"source": "国家集成电路产业基金", "relation": "投资", "target": "智信半导体", "round": "A轮", "amount": "30亿元", "year": 2020},
    {"source": "华为", "relation": "战略投资", "target": "智信半导体", "round": "A轮", "amount": "5亿元", "year": 2020},
    {"source": "小米", "relation": "战略投资", "target": "智信半导体", "round": "A轮", "amount": "3亿元", "year": 2020},

    {"source": "申洲国际", "relation": "战略投资", "target": "泰和纺织集团", "round": "战略投资", "amount": "2亿元", "year": 2010},

    # ========== TechFlow 合作关系（成功案例）==========
    {"source": "鼎盛科技有限公司", "relation": "使用产品", "target": "DataStream Lite", "year": 2023, "satisfaction": 4.5},
    {"source": "TechFlow", "relation": "服务客户", "target": "鼎盛科技有限公司", "project": "工厂数字化改造", "year": 2023},

    {"source": "明远物流科技", "relation": "使用产品", "target": "FlowControl-X100", "year": 2022, "satisfaction": 4.3},
    {"source": "TechFlow", "relation": "服务客户", "target": "明远物流科技", "project": "智慧仓储系统", "year": 2022},

    {"source": "光明医疗器械", "relation": "使用产品", "target": "FlowMind 平台", "year": 2024, "satisfaction": 4.8},
    {"source": "TechFlow", "relation": "服务客户", "target": "光明医疗器械", "project": "GMP质量追溯系统", "year": 2024},

    {"source": "天启化工集团", "relation": "使用产品", "target": "FlowControl-X500", "year": 2023, "satisfaction": 4.6},
    {"source": "TechFlow", "relation": "服务客户", "target": "天启化工集团", "project": "化工生产安全监控", "year": 2023},

    {"source": "晨曦食品加工", "relation": "使用产品", "target": "FlowControl-X100", "year": 2021, "satisfaction": 4.4},
    {"source": "TechFlow", "relation": "服务客户", "target": "晨曦食品加工", "project": "食品安全追溯系统", "year": 2021},

    {"source": "泰和纺织集团", "relation": "使用产品", "target": "FlowMind 平台", "year": 2022, "satisfaction": 4.5},
    {"source": "TechFlow", "relation": "服务客户", "target": "泰和纺织集团", "project": "智能染色工艺优化", "year": 2022},

    # ========== 竞品客户关系（陷阱测试数据）==========
    {"source": "恒通电子商务", "relation": "使用竞品", "target": "XX竞品实时数据平台", "year": 2021, "vendor": "XX竞品公司"},
    {"source": "星辰金融集团", "relation": "潜在客户", "target": "TechFlow", "status": "未合作", "note": "评估中"},

    # ========== 潜在客户（未合作）==========
    {"source": "云帆新能源", "relation": "潜在客户", "target": "TechFlow", "status": "未合作", "industry": "新能源电池"},
    {"source": "智信半导体", "relation": "潜在客户", "target": "TechFlow", "status": "未合作", "industry": "半导体制造"},

    # ========== 供应链关系 ==========
    {"source": "鼎盛科技有限公司", "relation": "云服务商", "target": "华为云", "service": "IaaS云计算"},
    {"source": "星辰金融集团", "relation": "云服务商", "target": "阿里云", "service": "金融云"},
    {"source": "明远物流科技", "relation": "设备供应商", "target": "海康威视", "service": "仓储监控设备"},
    {"source": "云帆新能源", "relation": "原材料供应商", "target": "赣锋锂业", "service": "锂材料"},
    {"source": "光明医疗器械", "relation": "认证机构", "target": "SGS", "service": "ISO认证"},
    {"source": "天启化工集团", "relation": "环保合作商", "target": "碧水源", "service": "废水处理"},

    # ========== 行业竞争关系 ==========
    {"source": "云帆新能源", "relation": "同行竞争", "target": "比亚迪电池", "industry": "动力电池"},
    {"source": "智信半导体", "relation": "同行竞争", "target": "中芯国际", "industry": "晶圆代工"},
    {"source": "恒通电子商务", "relation": "同行竞争", "target": "京东商城", "industry": "B2C电商"},
]
```

**关系类型统计**：
- 股权关系：12 条（母子公司、持股）
- 投资关系：19 条（VC/PE 投资）
- TechFlow 合作：12 条（成功案例，包括双向关系）
- 竞品客户：1 条（测试陷阱识别）
- 潜在客户：3 条（未合作）
- 供应链关系：6 条
- 竞争关系：3 条
- **总计：56 条**

**设计亮点**：
- ✅ **多层次关系网络**：覆盖股权、投资、合作、竞争等多维度
- ✅ **真实感模拟**：时间线合理（2010-2024）、金额梯度合理（5000万-30亿）
- ✅ **测试陷阱**：包含竞品客户（恒通），测试 RAG 能否识别并谨慎推荐
- ✅ **与实验一一致**：所有产品名称、案例数据与实验一对齐
- ✅ **完全虚构但合理**：投资方真实但投资对象虚构,避免命中训练数据

### 2.3 业务文档（复用实验一）

```python
# 已有 16 个 TechFlow 虚构文档
# 位于 data/fictional_knowledge_base.py
FICTIONAL_DOCUMENTS = [
    # 产品手册（6个核心文档）
    # 干扰文档（6个近似产品）
    # 同义词文档（4个）
]
```

### 2.4 数据组织方式

将企业图谱转化为可检索的文档：

```python
def company_to_documents(company: Dict) -> List[Dict]:
    """将企业图谱转为多个检索文档"""

    docs = []

    # 文档 1：企业基本信息
    docs.append({
        "id": f"{company['id']}_basic",
        "type": "company_profile",
        "title": f"{company['name']} 企业档案",
        "content": f"""
【企业名称】{company['name']}
【行业】{company['industry']}
【成立时间】{company['founded_date']}
【注册资本】{company['capital']}
【员工规模】{company['employees']}人
【CEO】{company['ceo']}
【经营范围】{company['business_scope']}
        """
    })

    # 文档 2：企业关系
    docs.append({
        "id": f"{company['id']}_relations",
        "type": "company_relations",
        "title": f"{company['name']} 企业关系",
        "content": f"""
【企业名称】{company['name']}
【母公司】{company.get('parent_company', '无')}
【子公司】{', '.join(company.get('subsidiaries', []))}
【投资方】{', '.join(company.get('investors', []))}
        """
    })

    # 文档 3：合作历史
    if company.get('past_projects'):
        for project in company['past_projects']:
            docs.append({
                "id": f"{company['id']}_project_{project['year']}",
                "type": "project_history",
                "title": f"{company['name']} 合作案例（{project['year']}）",
                "content": f"""
【客户】{company['name']}
【项目】{project['project']}
【时间】{project['year']}年
【合作方】{project['partner']}
【使用产品】{project['product']}
【项目成果】{project['result']}
                """
            })

    # 文档 4：痛点分析
    docs.append({
        "id": f"{company['id']}_painpoints",
        "type": "company_needs",
        "title": f"{company['name']} 业务痛点",
        "content": f"""
【企业名称】{company['name']}
【行业】{company['industry']}
【当前痛点】
{chr(10).join(f"- {pain}" for pain in company['pain_points'])}
        """
    })

    return docs
```

### 2.5 多源耦合策略

- **结构化 → 文本化**：企业图谱（结构化表 + 知识图谱）先按 `company_to_documents()` 规则生成描述性段落，再与实验一复用的 FICTIONAL_DOCUMENTS 一起进入同一检索索引，保证"左手 + 右手"真正融合。
- **知识图谱保持显式边**：除文本化外，`COMPANY_RELATIONS` 仍以边列表方式存储，便于在需要"母子公司/投资链"推理时直接遍历，保留原始设计中"结构化 + 知识图谱"并存的能力。
- **主题对齐**：所有公司、产品均围绕 TechFlow 及其实验一虚构产品线展开，回答中可以自然引用实验一的评测结论（例如推荐 qwen3-8b）。
- **可扩展性**：将三类数据都标注 `source_type`（graph/doc/edge），便于统计不同数据源的贡献度和延迟，占位以支持后续接入真实企业数据。
- **水印标记**：所有虚构数据统一添加 `"synthetic_source": "experiment_v2"` 字段，便于追踪和过滤。

### 2.6 数据统计总览

#### 数据规模汇总

| 数据类型 | 数量 | 说明 |
|---------|------|------|
| **企业主体** | 10 家 | 覆盖制造、金融、物流、新能源、医疗、电商、化工、食品、半导体、纺织 |
| **子公司** | ~20 个 | 平均每家企业 2-3 个子公司 |
| **企业关系边** | 56 条 | 股权12 + 投资19 + 合作12 + 竞品1 + 潜在3 + 供应链6 + 竞争3 |
| **业务文档** | 16 篇 | 复用实验一（产品手册6 + 干扰文档6 + 近义词4）|
| **生成检索文档** | ~60 篇 | 10家企业 × 4类文档（基本信息+关系+项目+痛点）+ 额外项目文档 |
| **总检索文档** | ~76 篇 | 企业图谱文档60 + 业务文档16 |

#### 企业合作状态分布

| 合作状态 | 数量 | 企业名称 |
|---------|------|---------|
| **已合作（成功案例）** | 6 家 | 鼎盛科技、明远物流、光明医疗、天启化工、晨曦食品、泰和纺织 |
| **竞品客户** | 1 家 | 恒通电子商务（使用 XX竞品平台）|
| **潜在客户（评估中）** | 1 家 | 星辰金融集团 |
| **潜在客户（未接触）** | 2 家 | 云帆新能源、智信半导体 |

#### 数据虚构程度验证

| 验证维度 | 策略 | 示例 |
|---------|------|------|
| **公司名称** | 造词组合,避免真实公司 | "鼎盛科技"而非"鼎盛集团"（真实存在）|
| **人名** | 常见姓名,避免特征名 | "李明""王芳"而非特殊名字 |
| **投资方** | 真实VC但投资对象虚构 | 红杉投资"鼎盛科技"（虚构公司）|
| **数据指标** | 合理但不精确到个位 | "35%提升"而非"34.7%提升" |
| **产品名称** | 沿用实验一虚构产品 | FlowControl-X100、FlowMind、DataStream |
| **时间线** | 2010-2024,避开热点时间 | 2023年合作而非2024年（避免热点）|

#### 数据可控性标记

每条数据包含以下元信息,便于追踪和调试:

```python
{
    "synthetic_source": "experiment_v2",  # 标记为实验数据
    "created_date": "2025-12-14",         # 生成日期
    "category": "company_graph",          # 数据类别
    "entity_type": "company",             # 实体类型
    "size_bytes": 1024,                   # 数据大小
    "token_count": 256                    # Token 数量（用于延迟估算）
}
```

#### 与实验一的数据对接

| 对接点 | 说明 |
|-------|------|
| **产品线** | 复用 FlowControl-X100/X500、FlowMind、DataStream 系列 |
| **案例数据** | 实验一案例客户（星辰汽车、蓝海电子）在实验二中作为"相似案例"引用 |
| **干扰项** | 复用实验一的近似产品（FlowMonitor、FlowModel）作为混淆测试 |
| **评分器** | 复用实验一的 LLM-as-judge 评分逻辑 |
| **模型选择** | 采用实验一结论的最优模型 qwen3-8b |

---

## 3. 测试用例设计

### 3.0 评分标准

#### 3.0.1 关键点覆盖率

```python
def calculate_key_points_coverage(expected_key_points: List[str],
                                   actual_answer: str) -> Dict:
    """
    计算关键点覆盖率

    Args:
        expected_key_points: 期望包含的关键点列表
        actual_answer: 实际生成的回答

    Returns:
        {
            "recall_score": 0-1,  # 召回率
            "covered_points": [],  # 覆盖的关键点
            "missing_points": []   # 遗漏的关键点
        }
    """
    covered = []
    missing = []

    for point in expected_key_points:
        if point in actual_answer:
            covered.append(point)
        else:
            missing.append(point)

    recall_score = len(covered) / len(expected_key_points) if expected_key_points else 0

    return {
        "recall_score": recall_score,
        "covered_points": covered,
        "missing_points": missing
    }
```

#### 3.0.2 数据源覆盖检查

```python
def check_source_coverage(expected_sources: Dict[str, bool],
                          retrieved_docs: List[Dict]) -> Dict:
    """
    检查是否召回了期望的数据源

    Args:
        expected_sources: {"company_profile": True, "business_docs": False}
        retrieved_docs: 检索到的文档列表

    Returns:
        {
            "passed": True/False,
            "actual_sources": ["company_profile", "project_history"],
            "missing_sources": []
        }
    """
    actual_sources = set([doc.get('type') for doc in retrieved_docs])
    required_sources = [k for k, v in expected_sources.items() if v]
    missing_sources = [s for s in required_sources if s not in actual_sources]

    return {
        "passed": len(missing_sources) == 0,
        "actual_sources": list(actual_sources),
        "missing_sources": missing_sources
    }
```

#### 3.0.3 通过标准

测试用例通过的标准:

| 维度 | 标准 | 说明 |
|-----|------|------|
| **关键点召回率** | recall_score >= 0.8 | 至少覆盖80%的关键点 |
| **数据源覆盖** | 召回所有required的数据源 | expected_sources中标记为True的都要召回 |
| **无幻觉内容** | 不包含预定义的幻觉词汇 | 如"X1000"、"量子芯片"等 |
| **综合判断** | 上述三项都满足 | 全部通过才算测试通过 |

**示例评分**:
```python
test_case = {
    "id": "fusion_test_001",
    "query": "鼎盛科技是做什么的？",
    "expected_key_points": ["智能制造", "成立于2015年", "注册资本5000万", "员工500人", "CEO 李明"],
    "expected_sources": {"company_profile": True, "business_docs": False}
}

# 假设实际回答
actual_answer = "鼎盛科技有限公司是一家智能制造企业,成立于2015年,注册资本5000万元,员工规模500人。"
retrieved_docs = [
    {"type": "company_profile", "content": "..."},
    {"type": "company_relations", "content": "..."}
]

# 评分
key_points_result = calculate_key_points_coverage(
    test_case["expected_key_points"],
    actual_answer
)
# 结果: recall_score=0.8 (4/5个关键点,缺少"CEO 李明")

source_result = check_source_coverage(
    test_case["expected_sources"],
    retrieved_docs
)
# 结果: passed=True (召回了company_profile)

# 最终判断
passed = (key_points_result["recall_score"] >= 0.8 and source_result["passed"])
# 结果: passed=True
```

### 测试用例 1：企业背景查询（图谱检索）
```python
{
    "id": "fusion_test_001",
    "category": "企业背景查询",
    "query": "鼎盛科技是做什么的？公司规模多大？",
    "expected_sources": {
        "company_profile": True,  # 企业档案
        "business_docs": False     # 不需要业务文档
    },
    "expected_key_points": [
        "智能制造行业",
        "成立于2015年",
        "注册资本5000万",
        "员工500人",
        "CEO 李明"
    ],
    "expected_bm25_advantage": True  # BM25 应精确匹配 "鼎盛科技"
}
```

### 测试用例 2：合作历史查询（图谱 + 关系）
```python
{
    "id": "fusion_test_002",
    "category": "合作历史查询",
    "query": "鼎盛科技之前有没有用过我们的产品？效果怎么样？",
    "expected_sources": {
        "project_history": True,   # 合作案例
        "company_profile": True,   # 企业基本信息
        "business_docs": True      # 产品文档
    },
    "expected_key_points": [
        "2023年合作过",
        "使用 DataStream Lite",
        "工厂数字化改造项目",
        "生产效率提升 35%"
    ]
}
```

### 测试用例 3：产品推荐（图谱 + 文档融合）
```python
{
    "id": "fusion_test_003",
    "category": "产品推荐",
    "query": "星辰金融集团想做实时风控，应该推荐哪个产品？",
    "expected_sources": {
        "company_profile": True,     # 了解客户（金融行业）
        "company_needs": True,       # 痛点（实时风控延迟高）
        "business_docs": True        # 产品文档
    },
    "expected_key_points": [
        "金融行业客户",
        "推荐 DataStream Pro",
        "适合实时风控场景",
        "低延迟（10ms）",
        "金融行业成功案例"
    ],
    "expected_fusion_value": True  # 需要融合企业信息 + 产品信息
}
```

### 测试用例 4：关系查询（图谱推理）
```python
{
    "id": "fusion_test_004",
    "category": "关系查询",
    "query": "鼎盛科技的母公司是谁？投资方有哪些？",
    "expected_sources": {
        "company_relations": True,  # 企业关系
        "company_profile": False
    },
    "expected_key_points": [
        "母公司是鼎盛集团",
        "投资方包括红杉资本、IDG",
        "B轮融资2亿元"
    ],
    "expected_bm25_advantage": True  # 需要精确匹配公司名称
}
```

### 测试用例 5：竞品客户识别（陷阱测试）
```python
{
    "id": "fusion_test_005",
    "category": "竞品客户识别",
    "query": "星辰金融之前有没有合作过？",
    "expected_sources": {
        "project_history": True,
        "company_relations": True
    },
    "expected_behavior": "识别出该客户使用竞品，谨慎推荐或说明差异化优势",
    "expected_key_points": [
        "星辰金融未合作过",
        "但使用过竞品 XX",
        "我们的产品相比竞品的优势..."
    ]
}
```

### 测试用例 6：混合检索对比（BM25 vs Dense）
```python
{
    "id": "fusion_test_006",
    "category": "混合检索效果验证",
    "query": "DataStream Pro 适合哪些行业？",
    "baseline_a": "仅 BM25 检索",
    "baseline_b": "仅 Dense 向量检索",
    "proposed": "BM25 + Dense 混合",
    "expected_result": "混合检索应召回更全面（产品文档 + 行业案例 + 客户档案）"
}
```

---

## 4. 评估指标

### 4.1 混合检索效果

| 指标 | 说明 | 计算方式 |
|------|------|----------|
| **召回率（Recall）** | 相关文档被召回的比例 | 召回相关文档数 / 总相关文档数 |
| **精确率（Precision）** | 召回文档中相关的比例 | 相关文档数 / 召回文档数 |
| **MRR（Mean Reciprocal Rank）** | 首个相关文档的排名 | 平均(1 / 首个相关文档排名) |
| **BM25 vs Dense 差异** | 两者召回文档的重叠度 | 交集 / 并集 |

### 4.2 多源融合质量

| 维度 | 说明 | 评分方式 |
|------|------|----------|
| **数据源覆盖** | 是否召回了所需的数据源 | 企业图谱/业务文档 命中情况 |
| **关系推理准确性** | 企业关系查询是否正确 | 母公司/投资方/合作历史 准确率 |
| **信息融合度** | 多源信息是否有机结合 | LLM-as-judge 评分 |
| **回答全面性** | 是否同时包含背景+推荐+案例 | 关键点覆盖率 |

### 4.3 对比实验

| 方案 | 数据源 | 检索方式 | 预期效果 |
|------|--------|----------|----------|
| **Baseline A** | 仅业务文档 | Dense 向量 | 缺少客户背景，推荐不精准 |
| **Baseline B** | 仅企业图谱 | BM25 | 有背景但无产品细节 |
| **Baseline C** | 图谱+文档 | Dense 向量 | 融合但关键词匹配弱 |
| **方案 D（推荐）** | 图谱+文档 | BM25 + Dense 混合 | 最全面准确 |

### 4.4 延迟可观测性（客户延时敏感需求）

- **分阶段打点**：`hybrid_search()` 输出的 `debug_info["latency"]` 记录 BM25、Dense、RRF、候选准备、Rerank 等耗时；同时记录 LLM 生成阶段的耗时，形成“检索→生成”全链路时间线。
- **可视化方式**：实验脚本生成 `outputs/experiment2_latency_breakdown.json` 与折线/堆叠柱状图，展示不同方案、不同公司查询的 P50/P95 延迟。
- **告警阈值**：设置 500ms 软阈值；若某阶段超阈值即写入 log，并在回答附带“本次检索耗时偏高”提示，便于与客户同步预期。
- **采样方法**：每个测试用例跑 ≥5 次，附带上下文 token 统计，分析上下文长度与延迟的关系，为后续优化（如缓存、裁剪）提供依据。

---

## 5. 实验实施计划

### 阶段 1：数据准备（Day 1）
- [ ] 设计 10 家虚构企业图谱
- [ ] 设计企业关系网络
- [ ] 将图谱数据转为检索文档格式
- [ ] 保存到 `data/company_graph.py`

### 阶段 2：混合检索实现（Day 1-2）
- [ ] 实现 BM25 检索模块
- [ ] 实现 RRF 融合算法
- [ ] 集成到现有 RAG 流程
- [ ] 更新 `rag_utils.py`

### 阶段 3：实验执行（Day 2）
- [ ] 实现 `experiments/test_02_hybrid_rag.py`
- [ ] 运行 4 种方案对比
- [ ] 收集混合检索 vs 纯向量的差异数据
- [ ] 使用 LLM-as-judge 评分

### 阶段 4：分析与报告（Day 3）
- [ ] 分析混合检索的提升效果
- [ ] 分析企业图谱融合的价值
- [ ] 生成报告 `outputs/experiment2_hybrid_rag_analysis.md`

---

## 6. 核心技术模块

### 6.1 BM25 实现（支持中文分词）

```python
import math
import jieba  # 新增：中文分词库
from collections import Counter
from typing import List, Dict, Tuple

class BM25:
    """BM25 算法实现 - 支持中文分词"""

    def __init__(self, corpus: List[str], k1: float = 1.5, b: float = 0.75):
        """
        参数：
            corpus: 文档列表
            k1: 词频饱和参数（通常 1.2-2.0）
            b: 长度归一化参数（0-1，0.75 常用）
        """
        self.k1 = k1
        self.b = b
        self.corpus = corpus

        # 使用jieba进行中文分词
        self.corpus_tokens = [list(jieba.cut(doc)) for doc in corpus]
        self.doc_len = [len(tokens) for tokens in self.corpus_tokens]
        self.avgdl = sum(self.doc_len) / len(corpus)
        self.doc_freqs = []
        self.idf = {}

        # 计算 IDF (使用分词后的token)
        df = Counter()
        for tokens in self.corpus_tokens:
            df.update(set(tokens))

        for term, freq in df.items():
            self.idf[term] = math.log((len(corpus) - freq + 0.5) / (freq + 0.5) + 1)

        # 计算每个文档的词频
        for tokens in self.corpus_tokens:
            self.doc_freqs.append(Counter(tokens))

    def search(self, query: str, top_k: int = 10) -> List[Tuple[int, float]]:
        """
        检索最相关的文档

        返回：[(doc_idx, score), ...]
        """
        # 查询也进行中文分词
        query_tokens = list(jieba.cut(query))
        scores = []

        for idx, doc_freq in enumerate(self.doc_freqs):
            score = 0
            for term in query_tokens:
                if term not in doc_freq:
                    continue

                freq = doc_freq[term]
                idf = self.idf.get(term, 0)

                # BM25 公式
                numerator = freq * (self.k1 + 1)
                denominator = freq + self.k1 * (1 - self.b + self.b * self.doc_len[idx] / self.avgdl)
                score += idf * (numerator / denominator)

            scores.append((idx, score))

        # 排序返回 Top-K
        scores.sort(key=lambda x: x[1], reverse=True)
        return scores[:top_k]


# 使用示例
if __name__ == "__main__":
    corpus = [
        "鼎盛科技有限公司是一家智能制造企业",
        "FlowControl-X100适合中小型自动化项目",
        "星辰金融集团专注于金融科技领域"
    ]

    bm25 = BM25(corpus)
    results = bm25.search("鼎盛科技是做什么的", top_k=2)

    for idx, score in results:
        print(f"文档{idx}: {corpus[idx]} (分数: {score:.2f})")
```

**依赖安装**:
```bash
uv add jieba
```

**注意事项**:
1. jieba分词会增加约10-20ms的初始化时间（首次加载词典）
2. 对于企业名称(如"鼎盛科技有限公司"),jieba会正确分词为["鼎盛", "科技", "有限公司"]
3. 对于产品型号(如"FlowControl-X100"),jieba会保留为单个token
4. 可以考虑添加自定义词典,将企业名称加入:
   ```python
   jieba.add_word("鼎盛科技")
   jieba.add_word("FlowControl-X100")
   ```

### 6.2 混合检索主函数

```python
import time

def hybrid_search(
    query: str,
    bm25_index: BM25,
    vector_index: VectorIndex,
    embedding_service: EmbeddingService,
    reranking_service: RerankingService,
    bm25_top_k: int = 20,
    dense_top_k: int = 20,
    final_top_k: int = 5
) -> Tuple[List[Dict], Dict]:
    """
    混合检索主流程

    返回：
        - final_results: 最终 Top-K 结果
        - debug_info: 调试信息（BM25/Dense/RRF 各阶段结果）
    """

    latency = {}

    # 步骤 1：BM25 稀疏检索
    t0 = time.perf_counter()
    bm25_results = bm25_index.search(query, top_k=bm25_top_k)
    latency["bm25_ms"] = (time.perf_counter() - t0) * 1000
    bm25_doc_ids = [idx for idx, score in bm25_results]

    # 步骤 2：Dense 向量检索
    t0 = time.perf_counter()
    query_vector = embedding_service.embed(query)
    dense_results = vector_index.search(query_vector, top_k=dense_top_k)
    latency["dense_ms"] = (time.perf_counter() - t0) * 1000
    dense_doc_ids = [r['doc_id'] for r in dense_results]

    # 步骤 3：RRF 融合
    t0 = time.perf_counter()
    rrf_results = rrf_fusion([bm25_doc_ids, dense_doc_ids], k=60)
    latency["rrf_ms"] = (time.perf_counter() - t0) * 1000

    # 步骤 4：取 Top-40 候选文档
    t0 = time.perf_counter()
    candidate_doc_ids = [doc_id for doc_id, score in rrf_results[:40]]
    candidate_docs = [vector_index.get_document(doc_id) for doc_id in candidate_doc_ids]
    latency["candidate_fetch_ms"] = (time.perf_counter() - t0) * 1000

    # 步骤 5：Reranking 精排
    t0 = time.perf_counter()
    final_results = reranking_service.rerank(
        query=query,
        documents=candidate_docs,
        top_k=final_top_k
    )
    latency["rerank_ms"] = (time.perf_counter() - t0) * 1000
    latency["retrieval_total_ms"] = sum(latency.values())

    # 调试信息
    debug_info = {
        "bm25_results": bm25_doc_ids[:5],
        "dense_results": dense_doc_ids[:5],
        "rrf_fused": candidate_doc_ids[:10],
        "final_reranked": [r['doc_id'] for r in final_results],
        "overlap_bm25_dense": len(set(bm25_doc_ids) & set(dense_doc_ids)),
        "latency": latency
    }

    return final_results, debug_info
```

### 6.3 Reranking 精排模块

#### 6.3.1 模型选择

使用 `BAAI/bge-reranker-v2-m3` - 中文效果最好的开源Reranker之一:
- 支持中英文混合
- 输入长度: query + passage <= 8192 tokens
- 模型大小: ~2GB
- 推理速度: ~50ms/query (batch_size=10)

#### 6.3.2 实现代码

```python
import time
from typing import List, Dict
from FlagEmbedding import FlagReranker


class RerankingService:
    """Reranking精排服务"""

    def __init__(self, model_name="BAAI/bge-reranker-v2-m3", use_fp16=True):
        """
        初始化Reranker

        Args:
            model_name: Huggingface模型名称
            use_fp16: 使用FP16加速(推荐)
        """
        print(f"加载Reranker模型: {model_name}")
        self.reranker = FlagReranker(model_name, use_fp16=use_fp16)
        print("Reranker加载完成")

    def rerank(self, query: str, documents: List[Dict], top_k: int = 5) -> List[Dict]:
        """
        对文档进行精排

        Args:
            query: 查询文本
            documents: 文档列表,每个文档包含'content'字段
            top_k: 返回Top-K文档

        Returns:
            排序后的Top-K文档列表
        """
        t0 = time.perf_counter()

        # 准备输入对: [[query, doc_content], ...]
        pairs = [[query, doc['content']] for doc in documents]

        # 计算relevance分数
        scores = self.reranker.compute_score(pairs, normalize=True)

        # 如果只有一个文档,scores是float而非list
        if not isinstance(scores, list):
            scores = [scores]

        # 排序
        scored_docs = list(zip(documents, scores))
        scored_docs.sort(key=lambda x: x[1], reverse=True)

        # 返回TopK
        top_docs = [doc for doc, score in scored_docs[:top_k]]

        elapsed = (time.perf_counter() - t0) * 1000
        print(f"Reranking完成: {len(documents)}篇 -> Top{top_k}, 耗时 {elapsed:.1f}ms")

        return top_docs


# 使用示例
if __name__ == "__main__":
    reranker = RerankingService()

    query = "鼎盛科技之前用过什么产品?"
    documents = [
        {"id": "doc1", "content": "鼎盛科技在2023年使用了DataStream Lite产品"},
        {"id": "doc2", "content": "FlowControl-X100适合中小型企业"},
        {"id": "doc3", "content": "鼎盛科技有限公司成立于2015年"}
    ]

    results = reranker.rerank(query, documents, top_k=2)
    for doc in results:
        print(f"- {doc['id']}: {doc['content']}")
```

#### 6.3.3 依赖安装

```bash
# 安装FlagEmbedding
uv add FlagEmbedding

# 首次运行会自动下载模型(~2GB)
# 模型缓存路径: ~/.cache/huggingface/hub/
```

#### 6.3.4 降级方案

如果模型加载失败或资源受限,可以使用简化的相似度排序:

```python
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np

class SimpleReranker:
    """简化版Reranker - 基于余弦相似度"""

    def __init__(self, embedding_service):
        self.embedding_service = embedding_service

    def rerank(self, query: str, documents: List[Dict], top_k: int = 5):
        query_emb = self.embedding_service.embed(query)
        doc_embs = [self.embedding_service.embed(d['content']) for d in documents]

        similarities = cosine_similarity([query_emb], doc_embs)[0]
        ranked_indices = np.argsort(similarities)[::-1][:top_k]

        return [documents[i] for i in ranked_indices]
```

#### 6.3.5 性能优化建议

1. **批量处理**: 如果有多个查询,使用batch推理
2. **内容截断**: 如果passage过长(>512 tokens),截断或只取摘要
3. **缓存**: 对于重复查询,缓存Reranking结果
4. **混合策略**: Reranking阶段只精排Top40候选,避免计算量过大

---

## 7. 预期产出

### 7.1 代码文件
- `data/company_graph.py`（企业图谱数据）
- `rag_utils.py`（新增 BM25、RRF 融合）
- `experiments/test_02_hybrid_rag.py`（实验脚本）

### 7.2 实验结果
- `outputs/experiment2_results_YYYYMMDD_HHMMSS.json`
- `outputs/experiment2_hybrid_rag_analysis.md`
- `outputs/experiment2_latency_breakdown.json`（分阶段耗时）
- `outputs/experiment2_latency_viz.png`（可视化图表）

### 7.3 关键发现（预期）
- 混合检索相比纯向量检索，召回率提升 XX%
- 企业图谱融合使回答全面性提升 XX%
- BM25 在企业名称、产品型号匹配上准确率 XX%
- 多源融合质量评分提升 XX 分

---

## 8. 技术亮点

### 8.1 混合检索的必要性
- BM25 保证关键词精确匹配（企业名、产品型号）
- Dense 向量补充语义理解（同义词、隐含需求）
- RRF 融合平衡两者，避免单一算法的局限性

### 8.2 企业图谱轻量化融合
- 无需引入图数据库，降低技术复杂度
- 将实体和关系转为文本文档，统一检索流程
- 适合中小规模场景（< 1万企业）

### 8.3 回到问题本质
- **左手（企业图谱）+ 右手（业务文档）** 真正融合
- 虚拟销售既能了解客户背景，又能精准推荐产品
- 形成"有效的炼丹炉"：数据 → 知识 → 智能推荐

---

## 9. 与实验一的关联

| 维度 | 实验一 | 实验二 |
|------|--------|--------|
| **核心问题** | 验证 RAG 减少幻觉 | 验证多源融合 + 混合检索 |
| **数据源** | 仅非结构化文档 | 企业图谱 + 业务文档 |
| **检索方式** | Dense 向量 + Reranking | BM25 + Dense + RRF + Reranking |
| **模型选择** | 对比 3 个模型 | 复用 qwen3-8b（实验一结论） |
| **评分方式** | LLM-as-judge | 复用实验一评分器 |
| **技术复杂度** | 中 | 高 |

---

## 10. 后续优化方向

### 短期优化
- 调优 RRF 参数 k（当前 60）
- 添加查询改写（Query Rewrite）
- 优化 jieba 自定义词典（添加更多企业名称和产品型号）

### 中期优化
- 引入 Elasticsearch 加速 BM25
- 支持实体链接（Entity Linking）
- 添加时间维度（企业信息更新）

### 长期优化
- 引入图数据库（Neo4j）支持复杂关系查询
- 实现动态检索策略（LLM 决定用 BM25 还是 Dense）
- 多模态支持（图表、PPT 内容提取）

---

**文档版本**：v2.0（重新设计）
**创建日期**：2025-12-14
**实验状态**：⏳ 设计完成，待实施
**关键变更**：回归问题初衷（企业图谱 + 业务文档融合），增加混合检索设计
