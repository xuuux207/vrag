<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechFlow è¯­éŸ³å®¢æœ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 480px;
            padding: 40px;
            text-align: center;
        }
        h1 { font-size: 28px; color: #333; margin-bottom: 8px; }
        .subtitle { font-size: 14px; color: #666; margin-bottom: 32px; }
        .status { font-size: 16px; color: #666; margin-bottom: 24px; min-height: 24px; }
        .transcript {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 16px;
            min-height: 120px;
            max-height: 240px;
            overflow-y: auto;
            text-align: left;
            margin-bottom: 24px;
            font-size: 14px;
            line-height: 1.6;
        }
        .message { margin-bottom: 12px; padding: 8px 12px; border-radius: 8px; }
        .message.user { background: #e0e7ff; color: #4f46e5; }
        .message.assistant { background: #fff; border: 1px solid #e5e7eb; color: #333; }
        .message-label { font-size: 11px; font-weight: 600; margin-bottom: 4px; opacity: 0.7; }
        .controls { display: flex; gap: 12px; justify-content: center; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ TechFlow è¯­éŸ³å®¢æœ</h1>
        <p class="subtitle">Azure Speech SDK æµè§ˆå™¨ç‰ˆ</p>

        <div class="status" id="statusText">ç‚¹å‡»"å¼€å§‹é€šè¯"å¯ç”¨éº¦å…‹é£</div>

        <div class="transcript" id="transcript">
            <div style="font-size: 12px; color: #999; line-height: 1.5;">
                ğŸ’¡ ä½¿ç”¨è¯´æ˜<br>
                â€¢ ç‚¹å‡»"å¼€å§‹é€šè¯"æˆæƒéº¦å…‹é£<br>
                â€¢ ç›´æ¥è¯´è¯ï¼Œè‡ªåŠ¨è¯†åˆ«<br>
                â€¢ AI å®æ—¶å›å¤å¹¶æœ—è¯»
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn" onclick="startConversation()">å¼€å§‹é€šè¯</button>
            <button class="btn" id="stopBtn" onclick="stopConversation()" disabled>ç»“æŸé€šè¯</button>
        </div>
    </div>

    <!-- Azure Speech SDK -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

    <script>
        let ws = null;
        let sessionId = null;
        let recognizer = null;
        let synthesizer = null;
        let isSpeaking = false;  // AI æ˜¯å¦æ­£åœ¨è¯´è¯
        let speechConfig = null;  // Azure Speech é…ç½®ï¼ˆä»åç«¯è·å–ï¼‰

        // WebSocket è¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket è¿æ¥æˆåŠŸ');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onerror = (error) => {
                console.error('WebSocket é”™è¯¯:', error);
                showError('è¿æ¥é”™è¯¯');
            };

            ws.onclose = () => {
                console.log('WebSocket å·²å…³é—­');
            };
        }

        // å¤„ç† WebSocket æ¶ˆæ¯
        function handleWebSocketMessage(message) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

            switch (message.type) {
                case 'session_info':
                    sessionId = message.session_id;
                    break;

                case 'user_message':
                    addMessage('user', message.text);
                    setStatus('AI æ­£åœ¨æ€è€ƒ...');
                    break;

                case 'assistant_message':
                    addMessage('assistant', message.text);
                    speakText(message.text);  // TTS æ’­æ”¾
                    break;

                case 'error':
                    showError(message.message);
                    setStatus('å‘ç”Ÿé”™è¯¯');
                    break;

                case 'info':
                    setStatus(message.message);
                    break;
            }
        }

        // å¼€å§‹é€šè¯
        async function startConversation() {
            try {
                // 1. è·å– Azure Speech é…ç½®
                setStatus('æ­£åœ¨è·å–é…ç½®...');
                const configResponse = await fetch('/api/speech-config');
                if (!configResponse.ok) {
                    throw new Error('æ— æ³•è·å–è¯­éŸ³é…ç½®');
                }
                speechConfig = await configResponse.json();
                console.log('è·å–åˆ° Speech é…ç½®:', { region: speechConfig.region });

                // 2. è¿æ¥ WebSocket
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                    await new Promise((resolve) => {
                        const check = setInterval(() => {
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                clearInterval(check);
                                resolve();
                            }
                        }, 100);
                    });
                }

                // 3. åˆå§‹åŒ– Azure Speech SDK
                const azureSpeechConfig = SpeechSDK.SpeechConfig.fromSubscription(
                    speechConfig.key,
                    speechConfig.region
                );
                azureSpeechConfig.speechRecognitionLanguage = speechConfig.language || "zh-CN";
                azureSpeechConfig.speechSynthesisVoiceName = speechConfig.voice_name || "zh-CN-XiaoxiaoNeural";

                // 4. åˆå§‹åŒ–è¯†åˆ«å™¨ï¼ˆè¿ç»­è¯†åˆ«ï¼‰
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                recognizer = new SpeechSDK.SpeechRecognizer(azureSpeechConfig, audioConfig);

                // è¯†åˆ«äº‹ä»¶
                recognizer.recognized = (s, e) => {
                    if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                        const text = e.result.text;
                        console.log('è¯†åˆ«åˆ°:', text);

                        // å‘é€åˆ°åç«¯ï¼ˆä¸åœ¨AIè¯´è¯æ—¶ï¼‰
                        if (ws && ws.readyState === WebSocket.OPEN && !isSpeaking) {
                            ws.send(JSON.stringify({
                                type: 'text',
                                data: text
                            }));
                        }
                    }
                };

                recognizer.canceled = (s, e) => {
                    console.error('è¯†åˆ«å–æ¶ˆ:', e.errorDetails);
                    recognizer.stopContinuousRecognitionAsync();
                };

                // å¼€å§‹è¿ç»­è¯†åˆ«
                recognizer.startContinuousRecognitionAsync();

                // 5. åˆå§‹åŒ–åˆæˆå™¨
                synthesizer = new SpeechSDK.SpeechSynthesizer(azureSpeechConfig);

                // 6. æ›´æ–° UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                setStatus('æ­£åœ¨ç›‘å¬...');

            } catch (error) {
                console.error('å¯åŠ¨å¤±è´¥:', error);
                showError('æ— æ³•å¯åŠ¨: ' + error.message);
            }
        }

        // åœæ­¢é€šè¯
        function stopConversation() {
            if (recognizer) {
                recognizer.stopContinuousRecognitionAsync();
                recognizer.close();
                recognizer = null;
            }

            if (synthesizer) {
                synthesizer.close();
                synthesizer = null;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            setStatus('é€šè¯å·²ç»“æŸ');
        }

        // TTS æ’­æ”¾
        function speakText(text) {
            if (!synthesizer) return;

            isSpeaking = true;
            setStatus('AI æ­£åœ¨è¯´è¯...');

            synthesizer.speakTextAsync(
                text,
                result => {
                    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                        console.log('TTS æ’­æ”¾å®Œæˆ');
                        isSpeaking = false;
                        setStatus('æ­£åœ¨ç›‘å¬...');
                    }
                },
                error => {
                    console.error('TTS å¤±è´¥:', error);
                    isSpeaking = false;
                    setStatus('æ­£åœ¨ç›‘å¬...');
                }
            );
        }

        // UI æ›´æ–°å‡½æ•°
        function setStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        function addMessage(role, text) {
            const transcript = document.getElementById('transcript');
            const message = document.createElement('div');
            message.className = `message ${role}`;

            const label = role === 'user' ? 'ä½ ' : 'AI';
            message.innerHTML = `
                <div class="message-label">${label}</div>
                <div>${text}</div>
            `;

            transcript.appendChild(message);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function showError(message) {
            const transcript = document.getElementById('transcript');
            const error = document.createElement('div');
            error.style.cssText = 'background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 12px;';
            error.textContent = 'âŒ ' + message;
            transcript.appendChild(error);
            transcript.scrollTop = transcript.scrollHeight;
        }

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            stopConversation();
        });
    </script>
</body>
</html>
